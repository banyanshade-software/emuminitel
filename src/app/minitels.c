/*
 * minitels.c
 *
 *  Created on: Mar 10, 2024
 *      Author: danielbraun
 */



#include <stdint.h>
#include <string.h>

#include "minitels.h"

#include "../utils/misc.h"
#include "../utils/itm_debug.h"
#include "../utils/lf_mqueue.h"
#include "../serial/serial.h"

// state
typedef enum {
	state_init = 0,
	state_q1_tx,
    state_q1,
    state_s1_tx,
    state_s2_tx,
    state_wait_s2,
    state_s3_tx,
    state_s3
} __attribute((packed)) minitel_state_t;

typedef struct minitel {
	uint32_t lasttick;
	minitel_state_t state;
    uint8_t rxseq; // for multiple car replies
    uint8_t model;
    uint8_t ntick;
} __attribute((packed)) minitel_t;

static minitel_t minitels[NUM_SERIALS];

#define SET_STATE(_idx, _m, _newstate) do {                      \
	itm_debug3(DBG_MTEL, "state", _idx, (_m)->state, _newstate); \
	(_m)->state = (_newstate);                                   \
} while(0)

#pragma mark -


static int process_id_car(int mntidx, minitel_t *m, uint8_t car);
static void send_welcome_msg(int mntidx, minitel_t *m);
static void send_model_msg(int mntidx, minitel_t *m);
static void send_mitterand(int mntidx, minitel_t *m);

#pragma mark -
void minitel_init_all(void)
{
	memset(minitels, 0, sizeof(minitels));
	for (int i=0; i<NUM_SERIALS; i++) {
		serial_start_rx(i);
	}
}

void minitel_processtxdone(int mntidx)
{
	minitel_t *m = &minitels[mntidx];
	switch (m->state) {
	case state_q1_tx:
		SET_STATE(mntidx, m, state_q1);
		break;
    case state_s1_tx:
        send_model_msg(mntidx, m);
        SET_STATE(mntidx, m, state_s2_tx);
        break;
    case state_s2_tx:
        m->ntick = 0;
        SET_STATE(mntidx, m, state_wait_s2);
        break;
    case state_s3_tx:
        SET_STATE(mntidx, m, state_s3);
        break;
        
    case state_wait_s2:
	case state_init:
	case state_q1:
    case state_s3:
        break;
	}
}

static void minitel_process_rxchar(int mntidx, minitel_t *m, uint8_t car);

void minitel_processrx(int mntidx)
{
	minitel_t *m   = &minitels[mntidx];
	serial_t  *ser = &serials[mntidx];
	for (;;) {
		uint8_t  c;
		int rc = mqf_read(ser->rxqueue, &c);
		if (rc) break;
		minitel_process_rxchar(mntidx, m, c);
	}
}

static void minitel_process_rxchar(int mntidx, minitel_t *m, uint8_t car)
{
	switch (m->state) {
    default:
	case state_init:
	case state_q1_tx:
		itm_debug3(DBG_MTEL, "ign car", mntidx, m->state, car);
		break;
	case state_q1:
		itm_debug2(DBG_MTEL, "id car", mntidx,  car);
        int rc = process_id_car(mntidx, m, car);
            if (rc>0) {
                send_welcome_msg(mntidx, m);
                SET_STATE(mntidx, m, state_s1_tx);
            }
		break;

	}
}


// PRO1 ESC 39
// ! 29 ! PRO1 7B ({)        ! Lecture ROM (Identification du terminal).          !

static const uint8_t mnt_ping[] = { 0x1B, 0x39, 0x7B };
//static const uint8_t mnt_ping[] = "coucou\n";

void minitel_tick(int mntidx, uint32_t tick)
{
	minitel_t *m = &minitels[mntidx];

	switch(m->state) {
	case state_init:
    case state_q1:
        m->rxseq = 0;
		serial_send_bytes(mntidx, mnt_ping, sizeof(mnt_ping), 0);
		SET_STATE(mntidx, m, state_q1_tx);
		break;
    case state_wait_s2:
        if (m->ntick++>=5) {
            send_mitterand(mntidx, m);
            SET_STATE(mntidx, m, state_s3_tx);
        }
        break;
	default:
		break;
	}
}


#pragma mark -



static int process_id_car(int mntidx, minitel_t *m, uint8_t car)
{
    switch(m->rxseq) {
        case 0:
            if (car != 0x01) return 0;
            break;
        case 1:
            // manufacturer
            break;
        case 2:
            m->model = car;
            break;
        case 3:
            // version
            break;
        case 4:
            m->rxseq = 0;
            if (car != 0x04) {
                return 0;
            }
            return 1;
    }
    m->rxseq++;
    return 0;
}

// --------- minitel models
static const char *models1[]={
    "Minitel 1 nr abcd",
    "Minitel 1 nr",
    "minitel 10 nr",
    "Minitel 1 couleur nr",
    "Minitel 10",
    "emulateur",
};
static const char *models2[]={
    "Minitel 1",
    "Minitel 1 couleur",
    "Terminatel 252.",
    "Minitel 1 Bi-standard",
    "Minitel 2",
    "Minitel 10 Bi-standard",
    "(Thomson?)",
    "Minitel 5",
    "Minitel 12"
};
static const char inconnu[] = "inconnu";
static const uint8_t welcome_msg[] = "Bonjour votre minitel est un :\n\n\r     \x1B\x4D";

static void send_welcome_msg(int mntidx, minitel_t *m)
{
    serial_send_bytes(mntidx, welcome_msg, sizeof(welcome_msg), 0);
}
static void send_model_msg(int mntidx, minitel_t *m)
{
    const char *str;

    if ((0)) {}
    else if (m->model<0x62) str = inconnu;
    else if (m->model>0x7A) str = inconnu;
    else if ((m->model>0x67) && (m->model<0x72)) str = inconnu;
    else if (m->model<0x72) {
        str = models1[m->model-0x62];
    } else {
        str = models2[m->model-0x72];
    }
    serial_send_bytes(mntidx, (uint8_t *)str, (int)strlen(str), 0);
}

static const uint8_t mitterand[] = {
    0x0c, 0x1f, 0x41, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x12, 0x45
  , 0x1b, 0x40, 0x58, 0x1b, 0x50, 0x1b, 0x47, 0x20, 0x1b, 0x5a, 0x40, 0x5e, 0x5f, 0x12, 0x49, 0x54
  , 0x1b, 0x57, 0x1b, 0x40, 0x1b, 0x59, 0x54, 0x30, 0x1b, 0x47, 0x20, 0x12, 0x45, 0x1b, 0x51, 0x12
  , 0x4b, 0x1f, 0x42, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x12, 0x43
  , 0x1b, 0x40, 0x40, 0x1b, 0x50, 0x1b, 0x44, 0x21, 0x1b, 0x47, 0x20, 0x1b, 0x5a, 0x40, 0x5e, 0x5f
  , 0x12, 0x4c, 0x54, 0x1b, 0x57, 0x1b, 0x40, 0x1b, 0x59, 0x54, 0x1b, 0x47, 0x20, 0x12, 0x44, 0x1b
  , 0x51, 0x12, 0x4b, 0x1f, 0x43, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20
  , 0x12, 0x42, 0x1b, 0x40, 0x48, 0x1b, 0x50, 0x1b, 0x47, 0x20, 0x12, 0x42, 0x1b, 0x5a, 0x5f, 0x12
  , 0x4f, 0x54, 0x1b, 0x57, 0x1b, 0x40, 0x1b, 0x59, 0x54, 0x1b, 0x47, 0x20, 0x12, 0x43, 0x1b, 0x51
  , 0x12, 0x4b, 0x1f, 0x44, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x12
  , 0x42, 0x1b, 0x50, 0x12, 0x42, 0x1b, 0x5a, 0x40, 0x58, 0x5f, 0x12, 0x50, 0x30, 0x1b, 0x57, 0x1b
  , 0x40, 0x1b, 0x59, 0x34, 0x1b, 0x47, 0x20, 0x12, 0x42, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x45, 0x41
  , 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x20, 0x1b, 0x50, 0x12, 0x42, 0x1b
  , 0x5a, 0x48, 0x25, 0x5b, 0x5f, 0x12, 0x50, 0x55, 0x1b, 0x59, 0x20, 0x1b, 0x57, 0x12, 0x43, 0x1b
  , 0x51, 0x12, 0x4b, 0x1f, 0x46, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20
  , 0x20, 0x1b, 0x50, 0x12, 0x43, 0x1b, 0x5a, 0x24, 0x5f, 0x12, 0x52, 0x1b, 0x59, 0x20, 0x4a, 0x1b
  , 0x57, 0x20, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x47, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b
  , 0x59, 0x1b, 0x49, 0x20, 0x20, 0x1b, 0x50, 0x12, 0x43, 0x1b, 0x5a, 0x28, 0x5f, 0x12, 0x52, 0x35
  , 0x1b, 0x59, 0x4a, 0x1b, 0x57, 0x20, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x48, 0x41, 0x0e, 0x1b
  , 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x20, 0x1b, 0x50, 0x12, 0x44, 0x1b, 0x5a, 0x5f
  , 0x12, 0x52, 0x35, 0x1b, 0x59, 0x4a, 0x1b, 0x57, 0x20, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x49
  , 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x20, 0x1b, 0x50, 0x12, 0x44
  , 0x1b, 0x5a, 0x5f, 0x12, 0x44, 0x3f, 0x27, 0x23, 0x12, 0x42, 0x2b, 0x5f, 0x12, 0x42, 0x3f, 0x2f
  , 0x23, 0x12, 0x42, 0x21, 0x1b, 0x59, 0x22, 0x1b, 0x57, 0x20, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f
  , 0x4a, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x20, 0x1b, 0x50, 0x12
  , 0x44, 0x1b, 0x5a, 0x5f, 0x12, 0x43, 0x27, 0x40, 0x50, 0x1b, 0x59, 0x20, 0x20, 0x1b, 0x5a, 0x5c
  , 0x30, 0x4a, 0x5f, 0x5d, 0x40, 0x50, 0x1b, 0x59, 0x20, 0x20, 0x1b, 0x5a, 0x5c, 0x1b, 0x59, 0x20
  , 0x20, 0x1b, 0x57, 0x12, 0x42, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x4b, 0x41, 0x0e, 0x1b, 0x54, 0x1b
  , 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x20, 0x1b, 0x50, 0x1b, 0x5a, 0x48, 0x1b, 0x59, 0x20, 0x1b
  , 0x5a, 0x40, 0x36, 0x5b, 0x5f, 0x12, 0x42, 0x38, 0x27, 0x40, 0x1b, 0x59, 0x20, 0x1b, 0x5a, 0x40
  , 0x50, 0x34, 0x22, 0x5f, 0x5f, 0x56, 0x58, 0x50, 0x50, 0x52, 0x58, 0x55, 0x1b, 0x59, 0x4a, 0x1b
  , 0x57, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x4c, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59
  , 0x1b, 0x49, 0x20, 0x20, 0x1b, 0x50, 0x1b, 0x5a, 0x4a, 0x34, 0x32, 0x5f, 0x12, 0x4a, 0x5d, 0x5d
  , 0x5f, 0x12, 0x48, 0x1b, 0x59, 0x4a, 0x1b, 0x57, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x4d, 0x41
  , 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x12, 0x42, 0x1b, 0x50, 0x1b, 0x5a
  , 0x5f, 0x37, 0x5f, 0x12, 0x54, 0x3d, 0x1b, 0x59, 0x4a, 0x1b, 0x57, 0x20, 0x1b, 0x51, 0x12, 0x4b
  , 0x1f, 0x4e, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x12, 0x42, 0x1b
  , 0x50, 0x1b, 0x5a, 0x4a, 0x5d, 0x5a, 0x5f, 0x4f, 0x5f, 0x12, 0x51, 0x55, 0x1b, 0x57, 0x1b, 0x59
  , 0x20, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x4f, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59
  , 0x1b, 0x49, 0x20, 0x12, 0x43, 0x1b, 0x50, 0x1b, 0x5a, 0x5f, 0x56, 0x37, 0x43, 0x5f, 0x12, 0x47
  , 0x4b, 0x5f, 0x12, 0x43, 0x3f, 0x5f, 0x12, 0x43, 0x35, 0x1b, 0x57, 0x1b, 0x59, 0x20, 0x20, 0x1b
  , 0x51, 0x12, 0x4b, 0x1f, 0x50, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20
  , 0x12, 0x43, 0x1b, 0x50, 0x1b, 0x5a, 0x4a, 0x5f, 0x12, 0x4a, 0x56, 0x51, 0x30, 0x1b, 0x59, 0x20
  , 0x20, 0x1b, 0x5a, 0x40, 0x5e, 0x5f, 0x12, 0x42, 0x35, 0x1b, 0x57, 0x1b, 0x59, 0x20, 0x20, 0x1b
  , 0x51, 0x12, 0x4b, 0x1f, 0x51, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20
  , 0x12, 0x44, 0x1b, 0x50, 0x1b, 0x5a, 0x4f, 0x5f, 0x12, 0x47, 0x4f, 0x5f, 0x12, 0x43, 0x55, 0x5c
  , 0x5f, 0x12, 0x44, 0x35, 0x1b, 0x57, 0x1b, 0x59, 0x20, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x52
  , 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x12, 0x45, 0x1b, 0x50, 0x1b
  , 0x5a, 0x22, 0x5f, 0x12, 0x45, 0x45, 0x5f, 0x12, 0x4b, 0x1b, 0x59, 0x4a, 0x1b, 0x57, 0x20, 0x20
  , 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x53, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49
  , 0x20, 0x12, 0x46, 0x1b, 0x50, 0x1b, 0x5a, 0x2a, 0x5f, 0x12, 0x46, 0x37, 0x27, 0x23, 0x1b, 0x59
  , 0x20, 0x12, 0x43, 0x1b, 0x5a, 0x21, 0x22, 0x5f, 0x5f, 0x1b, 0x59, 0x4a, 0x1b, 0x57, 0x20, 0x20
  , 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x54, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49
  , 0x20, 0x12, 0x46, 0x1b, 0x50, 0x1b, 0x5a, 0x4f, 0x4f, 0x5f, 0x12, 0x44, 0x45, 0x5c, 0x53, 0x2f
  , 0x2c, 0x2c, 0x2d, 0x2f, 0x58, 0x5e, 0x5f, 0x37, 0x1b, 0x57, 0x1b, 0x40, 0x1b, 0x59, 0x25, 0x1b
  , 0x47, 0x20, 0x20, 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x55, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b
  , 0x59, 0x1b, 0x49, 0x20, 0x12, 0x43, 0x1b, 0x40, 0x40, 0x1b, 0x50, 0x1b, 0x44, 0x21, 0x1b, 0x47
  , 0x20, 0x1b, 0x57, 0x1b, 0x40, 0x21, 0x1b, 0x50, 0x1b, 0x47, 0x34, 0x1b, 0x5a, 0x4b, 0x5f, 0x12
  , 0x47, 0x50, 0x50, 0x58, 0x5e, 0x5f, 0x5f, 0x27, 0x25, 0x1b, 0x57, 0x1b, 0x59, 0x20, 0x12, 0x42
  , 0x1b, 0x51, 0x12, 0x4b, 0x1f, 0x56, 0x41, 0x0e, 0x1b, 0x54, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49
  , 0x20, 0x20, 0x1b, 0x40, 0x50, 0x1b, 0x50, 0x1b, 0x44, 0x23, 0x1b, 0x47, 0x20, 0x12, 0x42, 0x1b
  , 0x57, 0x12, 0x42, 0x1b, 0x50, 0x54, 0x1b, 0x5a, 0x5f, 0x12, 0x42, 0x57, 0x5b, 0x5f, 0x12, 0x49
  , 0x1b, 0x57, 0x1b, 0x40, 0x1b, 0x59, 0x54, 0x1b, 0x47, 0x20, 0x12, 0x42, 0x1b, 0x51, 0x12, 0x4b
  , 0x1f, 0x57, 0x41, 0x0e, 0x1b, 0x50, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x12, 0x46, 0x1b
  , 0x57, 0x12, 0x43, 0x1b, 0x50, 0x54, 0x1b, 0x5a, 0x3f, 0x2f, 0x27, 0x5f, 0x12, 0x48, 0x37, 0x21
  , 0x1b, 0x59, 0x20, 0x20, 0x23, 0x1b, 0x57, 0x1b, 0x40, 0x50, 0x1b, 0x51, 0x1b, 0x47, 0x20, 0x12
  , 0x4a, 0x1f, 0x58, 0x41, 0x0e, 0x1b, 0x50, 0x1b, 0x47, 0x1b, 0x59, 0x1b, 0x49, 0x20, 0x12, 0x46
  , 0x1b, 0x57, 0x12, 0x44, 0x1b, 0x50, 0x54, 0x20, 0x20, 0x1b, 0x5a, 0x22, 0x2b, 0x2f, 0x12, 0x45
  , 0x27, 0x1b, 0x59, 0x20, 0x12, 0x46, 0x1b, 0x41, 0x23, 0x1b, 0x51, 0x1b, 0x40, 0x50, 0x1b, 0x47
  , 0x20, 0x12, 0x47, 0x1f, 0x46, 0x5e, 0x0e, 0x1b, 0x50, 0x1b, 0x41, 0x5f, 0x0b, 0x08, 0x5f, 0x1f
  , 0x45, 0x5f, 0x0e, 0x1b, 0x50, 0x20, 0x12, 0x46, 0x1f, 0x46, 0x5f, 0x0e, 0x1b, 0x50, 0x20, 0x12
  , 0x46, 0x1f, 0x46, 0x5f, 0x1b, 0x4f, 0x1b, 0x48, 0x35, 0x31, 0x1b, 0x4d, 0x2c, 0x1b, 0x4f, 0x1b
  , 0x48, 0x37
      };

static void send_mitterand(int mntidx, minitel_t *m)
{
    serial_send_bytes(mntidx, mitterand, sizeof(mitterand), 0);
}
